<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--NOTICE: Please open this file in your web browser. If presented with a security warning, you may safely tell it to allow the blocked content.-->
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD.\nAlthough MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD.\nNo support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
	<header>
		<license><![CDATA[http://opensource.org/licenses/gpl-license.php GNU General Public License v2]]></license>
		<title lang="en"><![CDATA[User Post Isolation]]></title>
		<description lang="en"><![CDATA[View all posts from a certain user in a topic.]]></description>
		<author-notes lang="en"><![CDATA[If this MOD has helped you, please consider donating by visiting http://www.phpbbdevelopers.net/board/lwdonate.php. All donations are voluntary and will be greatly appreciated.]]></author-notes>
		<author-group>
			<author>
				<realname><![CDATA[David King]]></realname>
				<username><![CDATA[imkingdavid]]></username>
				<homepage><![CDATA[http://www.phpbbdevelopers.net/]]></homepage>
				<email><![CDATA[imkingdavid@gmail.com]]></email>
			</author>
		</author-group>
		<mod-version>1.0.1</mod-version>
		<installation>
			<level>easy</level>
			<time>300</time>
			<target-version>3.0.7-PL1</target-version>
		</installation>
		<history>
			<entry>
				<date>2010-04-05</date>
				<rev-version>1.0.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Version 1.0.0 Released and Submitted to MOD DB]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2010-04-06</date>
				<rev-version>1.0.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Still keeping it at version 1.0.0, Re-submitted to MOD DB]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2010-05-01</date>
				<rev-version>1.0.1</rev-version>
				<changelog lang="en">
					<change><![CDATA[[fix] a couple of backend changes recommended by MOD Team]]></change>
					<change><![CDATA[[fix] drop down box defaults to last chosen option]]></change>
					<change><![CDATA[[feature] added "All users" option to select box to allow user to return to normal topic view.]]></change>
				</changelog>
			</entry>
			<link-group>
				<link type="contrib" href="contrib/update_1.0.0_to_1.0.1.xml" lang="en">Update Instructions (1.0.0 to 1.0.1)</link>
			</link-group>
		</history>
	</header>
	<action-group>
		<open src="language/en/common.php">
			<edit>
				<find><![CDATA[	'DISPLAY_POSTS'			=> 'Display posts from previous',]]></find>
				<action type="after-add"><![CDATA[//----[ User Post Isolation ]----\\
	'DISPLAY_USER_POSTS'	=> 'Display posts by user',
	'VIEW_ALL_POSTERS'	=> 'All users',
//----[ End User Post Isolation ]----\\]]></action>
			</edit>
		</open>
		<open src="viewtopic.php">
			<edit>
				<find><![CDATA[if ($sort_days)
{
	$min_post_time = time() - ($sort_days * 86400);

	$sql = 'SELECT COUNT(post_id) AS num_posts
		FROM ' . POSTS_TABLE . "
		WHERE topic_id = $topic_id
			AND post_time >= $min_post_time
		" . (($auth->acl_get('m_approve', $forum_id)) ? '' : 'AND post_approved = 1');
	$result = $db->sql_query($sql);
	$total_posts = (int) $db->sql_fetchfield('num_posts');
	$db->sql_freeresult($result);

	$limit_posts_time = "AND p.post_time >= $min_post_time ";

	if (isset($_POST['sort']))
	{
		$start = 0;
	}
}]]></find>
				<action type="after-add"><![CDATA[//----[ User Post Isolation ]----\\
elseif(isset($_POST['user_sort']) && request_var('user_select', 0) !== 0)
{
	$s_sort_user_id = request_var('user_select', 0);

	$sql = 'SELECT COUNT(post_id) AS num_posts
		FROM ' . POSTS_TABLE . "
		WHERE topic_id = $topic_id
			AND poster_id = $s_sort_user_id
		" . (($auth->acl_get('m_approve', $forum_id)) ? '' : 'AND post_approved = 1');
	$result = $db->sql_query($sql);
	$total_posts = (int) $db->sql_fetchfield('num_posts');
	$db->sql_freeresult($result);

	$limit_posts_time = '';
}
//----[ End User Post Isolation ]----\\]]></action>
			</edit>
			<edit>
				<find><![CDATA['U_BUMP_TOPIC'			=> (bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id'])) ? append_sid("{$phpbb_root_path}posting.$phpEx", "mode=bump&amp;f=$forum_id&amp;t=$topic_id&amp;hash=" . generate_link_hash("topic_$topic_id")) : '')
);]]></find>
				<action type="after-add"><![CDATA[//----[ User Post Isolation ]----\\
	$sql = 'SELECT DISTINCT p.poster_id AS poster_id, u.username AS username
		FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
		WHERE p.topic_id = ' . $topic_data['topic_id'] . '
			AND p.poster_id = u.user_id' . 
			(($auth->acl_get('m_approve', $forum_id)) ? '' : ' AND p.post_approved = 1') .
		' ORDER BY u.username';
	$result = $db->sql_query($sql);
	$user_ary = array();
	while($urow = $db->sql_fetchrow($result))
	{
		$selected = ($s_sort_user_id == $urow['poster_id']) ? ' selected="selected"' : '';
		$user_ary[] = '<option value="' . $urow['poster_id'] . '"' . $selected . '>' . $urow['username'] . '</option>';
	}
	$s_topic_users = implode(' ', $user_ary);
	$db->sql_freeresult($result);
	$template->assign_vars(array(
		'S_SELECT_SORT_USERS'	=> ($s_topic_users) ? '<select name="user_select"><option value="0">' . $user->lang['VIEW_ALL_POSTERS'] . '</option>' . $s_topic_users . '</select>' : '',
	));
//----[ End User Post Isolation ]----\\]]></action>
			</edit>
			<edit>
				<find><![CDATA[$sql = $db->sql_build_query('SELECT', array(
	'SELECT'	=> 'u.*, z.friend, z.foe, p.*',]]></find>
				<action type="before-add"><![CDATA[//----[ User Post Isolation ]----\\
$s_sort_user_id = (isset($_POST['user_sort'])) ? request_var('user_select', 0) : 0;
$usort_where = ($s_sort_user_id) ? ' AND p.poster_id = ' . $s_sort_user_id : '';
//----[ End User Post Isolation ]----\\]]></action>
			</edit>
			<edit>
				<find><![CDATA[	'WHERE'		=> $db->sql_in_set('p.post_id', $post_list) . '
		AND u.user_id = p.poster_id']]></find>
				<action type="after-add"><![CDATA[//----[ User Post Isolation ]----\\
		. $usort_where
//----[ End User Post Isolation ]----\\]]></action>
			</edit>
		</open>
		
		<open src="styles/prosilver/template/viewtopic_body.html">
			<edit>
				<find><![CDATA[<label>{L_SORT_BY} {S_SELECT_SORT_KEY}</label> <label>{S_SELECT_SORT_DIR} <input type="submit" name="sort" value="{L_GO}" class="button2" /></label>]]></find>
				<action type="after-add"><![CDATA[        <br /><label>{L_DISPLAY_USER_POSTS}: {S_SELECT_SORT_USERS} <input type="submit" name="user_sort" value="{L_GO}" class="button2" /></label>]]></action>
			</edit>
		</open>
		<diy-instructions lang="en"><![CDATA[After all edits have been performed, navigate to the ACP and purge the cache and refresh the template.]]></diy-instructions>
	</action-group>
</mod>
